<html>
  <head>
    <!-- load react -->
    <script src="https://unpkg.com/react/umd/react.production.min.js"></script>
    <!-- load react dom -->
    <script src="https://unpkg.com/react-dom/umd/react-dom.production.min.js"></script>
    <!-- load pixi -->
    <script src="https://unpkg.com/pixi.js/dist/pixi.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.24.0/babel.js"></script>

    <link rel="stylesheet" type="text/css" href="./styles.css" />
  </head>
  <body>
    <div class="app-root"></div>
    <div class="canvas-root"></div>

    <script type="text/babel">
      const CANVAS_ROOT = document.querySelector('.canvas-root');
      const APP_ROOT = document.querySelector('.app-root');
      const BUNNY_SRC =
        'https://s3-us-west-2.amazonaws.com/s.cdpn.io/693612/IaUrttj.png';

      class BunnyItem extends PIXI.Sprite {
        constructor(id) {
          super(PIXI.Texture.from(BUNNY_SRC));

          this.id = id;
        }

        position() {
          let index = this.parent.getChildIndex(this);
          this.x = 30 + index * 50;
          this.y = 30;
        }

        get selected() {
          return this._selected;
        }

        set selected(v) {
          this._selected = v;
        }

        // select
      }

      class CanvasApplication extends PIXI.Application {
        constructor() {
          super({
            width: CANVAS_ROOT.clientWidth,
            height: CANVAS_ROOT.clientHeight,
            transparent: true
          });
        }

        get bunnies() {
          return this.stage.children.filter(child instanceof BunnyItem);
        }

        addBunny(id) {
          let bunny = new BunnyItem(id);
          this.stage.addChild(bunny);
          bunny.position();
        }
      }

      class BunnyListInputs extends React.Component {
        constructor(props) {
          super();

          this.state = {
            items_selected: [],
            inputs: [
              {
                id: 'amount',
                type: 'number',
                value: 12,
                min: 1,
                max: 64,
                step: 1,
                label: 'Bunnies No.',
                onChange: ev => this.onChangeAmount(ev.target.value)
              },
              {
                id: 'scale',
                type: 'range',
                value: 1,
                min: 1,
                max: 1.6,
                step: 0.1,
                label: 'Bunny Size'
              },
              {
                id: 'rotation',
                type: 'range',
                value: 0,
                min: -1,
                max: 1,
                step: 0.1,
                label: 'Bunny Rotation'
              }
            ]
          };

          this.onChange = this.onChange.bind(this);
          this.onChangeAmount = this.onChangeAmount.bind(this);
        }

        componentDidMount() {
          let amount = this.state.inputs.find(input => input.id === 'amount')
            .value;

          let bunnies = new Array(amount).fill(0).map(bunny => {
            this.props.canvas.addBunny();
          });
        }

        onChangeAmount(value) {
          let inputs = [...this.state.inputs].map(input => {
            if (input.id === 'amount') {
              input.value = Number(value);
            }
            return input;
          });

          this.setState({
            ...this.state,
            inputs
          });
        }

        onChange(id, value) {
          console.log(id, value);
        }

        renderInput(input) {
          let onChange = input.onChange
            ? input.onChange // when a custom handler prop if exists
            : ev => this.onChange(input.id, ev.target.value); // else use the generic onChange handler

          return (
            <div id={`bunny-input-${input.id}`}>
              <label for={input.id}>{input.label}</label>
              <input {...input} onChange={onChange} />
            </div>
          );
        }

        render() {
          let inputs = this.state.inputs;
          let items_selected = this.state.items_selected;

          return (
            <div className="bunny-inputs">
              {inputs.map(input => this.renderInput(input))}
              <label>Selected Bunnies: {items_selected.length}</label>
            </div>
          );
        }
      }

      class App extends React.Component {
        constructor() {
          super();

          this.canvas = new CanvasApplication();
          CANVAS_ROOT.appendChild(this.canvas.view);
        }

        render() {
          if (!this.canvas) return;

          return <BunnyListInputs canvas={this.canvas} />;
        }
      }

      ReactDOM.render(<App />, APP_ROOT);
    </script>
  </body>
</html>
